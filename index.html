// =================================================================
// æ­¥é©Ÿä¸€ï¼šæ¨¡æ“¬æˆç¸¾æ•¸æ“šæ¥æ”¶
// -----------------------------------------------------------------


// ç¢ºä¿é€™æ˜¯å…¨åŸŸè®Šæ•¸
let finalScore = 0; 
let maxScore = 0;
let scoreText = "å°šæœªæ”¶åˆ°æˆç¸¾"; // ç”¨æ–¼ p5.js ç¹ªåœ–çš„æ–‡å­—

// ã€æ–°å¢ã€‘ç…™ç«ç›¸é—œå…¨åŸŸè®Šæ•¸
let fireworks = []; // å„²å­˜æ‰€æœ‰æ´»èºçš„ç…™ç«å¯¦ä¾‹
let gravity; // ç”¨æ–¼ç²’å­ç³»çµ±çš„é‡åŠ›å‘é‡


window.addEventListener('message', function (event) {
    // åŸ·è¡Œä¾†æºé©—è­‰...
    // ...
    const data = event.data;
    
    if (data && data.type === 'H5P_SCORE_RESULT') {
        
        // !!! é—œéµæ­¥é©Ÿï¼šæ›´æ–°å…¨åŸŸè®Šæ•¸ !!!
        const oldFinalScore = finalScore;
        const oldMaxScore = maxScore;
        
        finalScore = data.score; // æ›´æ–°å…¨åŸŸè®Šæ•¸
        maxScore = data.maxScore;
        scoreText = `æœ€çµ‚æˆç¸¾åˆ†æ•¸: ${finalScore}/${maxScore}`;
        
        console.log("æ–°çš„åˆ†æ•¸å·²æ¥æ”¶:", scoreText); 
        
        // ----------------------------------------
        // é—œéµæ­¥é©Ÿ 2: å‘¼å«é‡æ–°ç¹ªè£½ (è¦‹æ–¹æ¡ˆäºŒ)
        // ----------------------------------------
        // æ¯æ¬¡æ”¶åˆ°æ–°åˆ†æ•¸éƒ½å…ˆå‘¼å«ä¸€æ¬¡ redraw() ä¾†æ›´æ–°éœæ…‹ç•«é¢
        if (typeof redraw === 'function') {
            redraw(); 
        }
        
        // ã€ä¿®æ”¹ã€‘åˆ†æ•¸æ»¿åˆ†æ™‚è§¸ç™¼ä¸€å€‹ç…™ç«ï¼Œä¸¦å•Ÿå‹•å‹•ç•«å¾ªç’°
        if (maxScore > 0 && finalScore === maxScore && (oldFinalScore !== finalScore || oldMaxScore !== maxScore)) {
            // åœ¨ç•«é¢åº•éƒ¨éš¨æ©Ÿä½ç½®ç™¼å°„ä¸€å€‹ç…™ç«
            fireworks.push(new Firework(random(width * 0.2, width * 0.8), height)); 
            // ç”±æ–¼ç…™ç«æ˜¯å‹•ç•«ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ draw() å‡½å¼æŒçºŒå¾ªç’°
            loop(); 
        } else if (finalScore !== maxScore) {
            // å¦‚æœä¸æ˜¯æ»¿åˆ†ï¼Œç¢ºä¿åœ¨æ›´æ–°éœæ…‹åˆ†æ•¸å¾Œåœæ­¢å‹•ç•«å¾ªç’°
            noLoop();
        }
    }
}, false);


// =================================================================
// æ­¥é©ŸäºŒï¼šä½¿ç”¨ p5.js ç¹ªè£½åˆ†æ•¸ (åœ¨ç¶²é  Canvas ä¸Šé¡¯ç¤º)
// -----------------------------------------------------------------

function setup() { 
    createCanvas(windowWidth / 2, windowHeight / 2); 
    // ã€ä¿®æ”¹ã€‘åˆå§‹åŒ–é‡åŠ›
    gravity = createVector(0, 0.2);
    // ã€ä¿®æ”¹ã€‘ä½¿ç”¨ HSB é¡è‰²æ¨¡å¼ï¼Œè®“ç…™ç«é¡è‰²è®ŠåŒ–æ›´æ–¹ä¾¿
    colorMode(HSB); 
    
    // åˆå§‹ç‹€æ…‹ï¼šåœæ­¢å¾ªç’°ï¼Œç­‰å¾…åˆ†æ•¸æˆ–ç…™ç«ä¾†å•Ÿå‹•å®ƒ
    noLoop(); 
} 

// score_display.js ä¸­çš„ draw() å‡½æ•¸ç‰‡æ®µ

function draw() { 
    // ã€ä¿®æ”¹ã€‘æ¸…é™¤èƒŒæ™¯ï¼Œä½¿ç”¨å¸¶æœ‰é€æ˜åº¦çš„é»‘è‰²èƒŒæ™¯ (0, 0, 0, 50) 
    // é€™æ˜¯ç”¢ç”Ÿç…™ç«å°¾è·¡ï¼ˆtrail effectï¼‰çš„**é—œéµ**ã€‚
    background(0, 0, 0, 50); 
    
    let percentage = maxScore > 0 ? (finalScore / maxScore) * 100 : 0;

    // -----------------------------------------------------------------
    // C. è™•ç†ç…™ç«æ•ˆæœ (å„ªå…ˆé¡¯ç¤ºåœ¨èƒŒæ™¯ä¹‹ä¸Š)
    // -----------------------------------------------------------------
    for (let i = fireworks.length - 1; i >= 0; i--) {
        fireworks[i].update();
        fireworks[i].show();
        if (fireworks[i].done()) {
            fireworks.splice(i, 1); // ç§»é™¤å·²çµæŸçš„ç…™ç«
        }
    }
    
    // ã€æ–°å¢ã€‘å¦‚æœæ²’æœ‰ä»»ä½•ç…™ç«åœ¨ç•«é¢ä¸Šï¼Œä¸”ä¸æ˜¯æ»¿åˆ†ç‹€æ…‹ï¼Œå‰‡åœæ­¢å¾ªç’°
    // å¦‚æœæ˜¯æ»¿åˆ†ç‹€æ…‹ï¼Œæˆ‘å€‘å¸Œæœ›å¯ä»¥æŒçºŒç™¼å°„æ–°ç…™ç«ï¼Œæ‰€ä»¥ä¿æŒ loop()
    if (fireworks.length === 0 && finalScore !== maxScore) {
        noLoop(); 
    }
    
    // -----------------------------------------------------------------
    // A. æ ¹æ“šåˆ†æ•¸å€é–“æ”¹è®Šæ–‡æœ¬é¡è‰²å’Œå…§å®¹ (ç•«é¢åæ˜ ä¸€)
    // -----------------------------------------------------------------
    
    // ç¢ºä¿æ–‡æœ¬æ¸…æ™°ï¼šåœ¨æ–‡å­—å‘¨åœç¹ªè£½ä¸€å€‹åŠé€æ˜çš„ç™½è‰²çŸ©å½¢
    fill(255, 200); 
    rectMode(CENTER);
    noStroke();
    rect(width / 2, height / 2, width, 250); // è¦†è“‹æ–‡å­—å‘¨åœå€åŸŸ
    
    textSize(80); 
    textAlign(CENTER);
    
    if (percentage >= 100 && maxScore > 0) {
        // æ»¿åˆ†ï¼šé¡¯ç¤ºç¥è³€æ–‡æœ¬
        fill(60, 255, 255); // é®®è±”çš„é»ƒç¶ è‰² (HSB)
        text("ğŸ‰ å®Œç¾ï¼æ­å–œæ»¿åˆ†ï¼ ğŸ‰", width / 2, height / 2 - 50);
        
        // æ»¿åˆ†æ™‚ï¼Œå¦‚æœç…™ç«åˆ—è¡¨ç‚ºç©ºï¼Œå‰‡æ¯éš”ä¸€æ®µæ™‚é–“å†ç™¼å°„ä¸€å€‹æ–°çš„ç…™ç«
        if (fireworks.length < 3 && frameCount % 30 === 0) { // æ¯ 30 å¹€ç™¼å°„
             fireworks.push(new Firework(random(width * 0.2, width * 0.8), height));
        }

    } else if (percentage >= 90) {
        // é«˜åˆ†
        fill(100, 255, 200); // ç¶ è‰²
        text("æ­å–œï¼å„ªç•°æˆç¸¾ï¼", width / 2, height / 2 - 50);
        
    } else if (percentage >= 60) {
        // ä¸­ç­‰åˆ†æ•¸
        fill(40, 255, 200); // é»ƒè‰²
        text("æˆç¸¾è‰¯å¥½ï¼Œè«‹å†æ¥å†å²ã€‚", width / 2, height / 2 - 50);
        
    } else if (percentage > 0) {
        // ä½åˆ†
        fill(0, 255, 200); // ç´…è‰²
        text("éœ€è¦åŠ å¼·åŠªåŠ›ï¼", width / 2, height / 2 - 50);
        
    } else {
        // å°šæœªæ”¶åˆ°åˆ†æ•¸æˆ–åˆ†æ•¸ç‚º 0
        fill(150);
        text(scoreText, width / 2, height / 2);
    }

    // é¡¯ç¤ºå…·é«”åˆ†æ•¸
    textSize(50);
    fill(0); // é»‘è‰²æ–‡å­—
    text(`å¾—åˆ†: ${finalScore}/${maxScore}`, width / 2, height / 2 + 50);
    
    
    // -----------------------------------------------------------------
    // B. æ ¹æ“šåˆ†æ•¸è§¸ç™¼ä¸åŒçš„å¹¾ä½•åœ–å½¢åæ˜  (ç•«é¢åæ˜ äºŒ)
    // -----------------------------------------------------------------
    
    if (percentage >= 90) {
        // ç•«ä¸€å€‹å¤§åœ“åœˆä»£è¡¨å®Œç¾ 
        fill(100, 255, 150, 0.5); // ç¶ è‰² (HSB + é€æ˜åº¦)
        noStroke();
        circle(width / 2, height / 2 + 150, 150);
        
    } else if (percentage >= 60) {
        // ç•«ä¸€å€‹æ–¹å½¢ 
        fill(40, 255, 150, 0.5); // é»ƒè‰² (HSB + é€æ˜åº¦)
        rectMode(CENTER);
        rect(width / 2, height / 2 + 150, 150, 150);
    }
}

// =================================================================
// æ­¥é©Ÿä¸‰ï¼šå®šç¾©ç…™ç«å’Œç²’å­é¡åˆ¥ (ç”¨æ–¼ç‰¹æ•ˆ)
// -----------------------------------------------------------------

class Particle {
    constructor(x, y, hu, firework) {
        this.pos = createVector(x, y);
        this.firework = firework;
        this.lifespan = 255;
        this.hu = hu; // ç²’å­çš„è‰²ç›¸ (Hue)

        if (this.firework) {
            // ç…™ç«ä¸Šå‡éšæ®µ (ç«ç®­)
            this.vel = createVector(0, random(-12, -8));
        } else {
            // çˆ†ç‚¸å¾Œçš„ç²’å­
            this.vel = p5.Vector.random2D(); // éš¨æ©Ÿæ–¹å‘
            this.vel.mult(random(2, 10)); // éš¨æ©Ÿé€Ÿåº¦
        }
        this.acc = createVector(0, 0);
    }

    applyForce(force) {
        // æ–½åŠ çš„åŠ›èˆ‡ç²’å­çš„è³ªé‡ç„¡é—œï¼Œå› æ­¤ç›´æ¥ç›¸åŠ 
        this.acc.add(force); 
    }

    update() {
        if (!this.firework) {
            this.vel.mult(0.9); // çˆ†ç‚¸ç²’å­é€Ÿåº¦éš¨æ™‚é–“è¡°æ¸›
            this.lifespan -= 4; // å£½å‘½æ¸›å°‘ï¼Œç”¢ç”Ÿæ¶ˆå¤±æ•ˆæœ
        }
        this.vel.add(this.acc);
        this.pos.add(this.vel);
        this.acc.mult(0); // é‡è¨­åŠ é€Ÿåº¦
    }

    done() {
        return this.lifespan < 0;
    }

    show() {
        // è¨­å®š HSB æ¨¡å¼ä¸‹çš„é¡è‰²
        strokeWeight(this.firework ? 4 : 2); // ç«ç®­ç²—ä¸€é»
        // HSB é¡è‰²ï¼šè‰²ç›¸(H), é£½å’Œåº¦(S), äº®åº¦(B), é€æ˜åº¦(Alpha)
        stroke(this.hu, 255, 255, this.firework ? 255 : this.lifespan);
        
        point(this.pos.x, this.pos.y);
    }
}

class Firework {
    constructor(x, y) {
        this.hu = random(255); // éš¨æ©Ÿé¡è‰²
        this.firework = new Particle(x, y, this.hu, true); // ç«ç®­ç²’å­
        this.exploded = false;
        this.particles = [];
    }

    update() {
        if (!this.exploded) {
            this.firework.applyForce(gravity);
            this.firework.update();

            // çˆ†ç‚¸æ¢ä»¶ï¼šç•¶ç«ç®­é–‹å§‹ä¸‹å¢œæ™‚ (å‚ç›´é€Ÿåº¦ç”±è² è½‰æ­£)
            if (this.firework.vel.y >= 0) {
                this.exploded = true;
                this.explode();
            }
        }

        for (let i = this.particles.length - 1; i >= 0; i--) {
            this.particles[i].applyForce(gravity);
            this.particles[i].update();
            if (this.particles[i].done()) {
                this.particles.splice(i, 1);
            }
        }
    }

    explode() {
        for (let i = 0; i < 100; i++) { // ç”Ÿæˆ 100 å€‹ç²’å­
            const p = new Particle(this.firework.pos.x, this.firework.pos.y, this.hu, false);
            this.particles.push(p);
        }
    }

    show() {
        if (!this.exploded) {
            this.firework.show();
        }
        
        for (const p of this.particles) {
            p.show();
        }
    }

    done() {
        // å¦‚æœå·²ç¶“çˆ†ç‚¸ä¸”æ‰€æœ‰ç²’å­éƒ½æ¶ˆå¤±äº†ï¼Œå‰‡ç…™ç«çµæŸ
        return this.exploded && this.particles.length === 0;
    }
}
