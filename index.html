// =================================================================
// æ­¥é©Ÿä¸€ï¼šæ¨¡æ“¬æˆç¸¾æ•¸æ“šæ¥æ”¶
// -----------------------------------------------------------------


// let scoreText = "æˆç¸¾åˆ†æ•¸: " + finalScore + "/" + maxScore;
// ç¢ºä¿é€™æ˜¯å…¨åŸŸè®Šæ•¸
let finalScore = 0; 
let maxScore = 0;
let scoreText = ""; // ç”¨æ–¼ p5.js ç¹ªåœ–çš„æ–‡å­—

// ã€æ–°å¢ã€‘ç…™ç«ç›¸é—œå…¨åŸŸè®Šæ•¸
let fireworks = []; // å„²å­˜æ‰€æœ‰æ´»èºçš„ç…™ç«å¯¦ä¾‹
let gravity; // ç”¨æ–¼ç²’å­ç³»çµ±çš„é‡åŠ›å‘é‡


window.addEventListener('message', function (event) {
    // åŸ·è¡Œä¾†æºé©—è­‰...
    // ...
    const data = event.data;
    
    if (data && data.type === 'H5P_SCORE_RESULT') {
        
        // !!! é—œéµæ­¥é©Ÿï¼šæ›´æ–°å…¨åŸŸè®Šæ•¸ !!!
        finalScore = data.score; // æ›´æ–°å…¨åŸŸè®Šæ•¸
        maxScore = data.maxScore;
        scoreText = `æœ€çµ‚æˆç¸¾åˆ†æ•¸: ${finalScore}/${maxScore}`;
        
        console.log("æ–°çš„åˆ†æ•¸å·²æ¥æ”¶:", scoreText); 
        
        // ----------------------------------------
        // é—œéµæ­¥é©Ÿ 2: å‘¼å«é‡æ–°ç¹ªè£½ (è¦‹æ–¹æ¡ˆäºŒ)
        // ----------------------------------------
        if (typeof redraw === 'function') {
            redraw(); 
        }
        
        // ã€æ–°å¢ã€‘åˆ†æ•¸æ»¿åˆ†æ™‚è§¸ç™¼ä¸€å€‹ç…™ç«
        if (maxScore > 0 && finalScore === maxScore) {
            // åœ¨ç•«é¢åº•éƒ¨ä¸­å¤®æˆ–éš¨æ©Ÿä½ç½®ç™¼å°„ä¸€å€‹ç…™ç«
            fireworks.push(new Firework(width / 2, height)); 
            // ç”±æ–¼ç…™ç«æ˜¯å‹•ç•«ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ draw() å‡½æ•¸æŒçºŒå¾ªç’°
            loop(); 
        }
    }
}, false);


// =================================================================
// æ­¥é©ŸäºŒï¼šä½¿ç”¨ p5.js ç¹ªè£½åˆ†æ•¸ (åœ¨ç¶²é  Canvas ä¸Šé¡¯ç¤º)
// -----------------------------------------------------------------

function setup() { 
    // ... (å…¶ä»–è¨­ç½®)
    createCanvas(windowWidth / 2, windowHeight / 2); 
    background(255); 
    // ã€ä¿®æ”¹ã€‘setup ä¸­ä¸å†æ˜¯ noLoop()ï¼Œè€Œæ˜¯è®“å®ƒåœ¨ draw() çµæŸæ™‚æ±ºå®šæ˜¯å¦åœæ­¢
    // noLoop(); // å¦‚æœæ‚¨å¸Œæœ›åˆ†æ•¸åªæœ‰åœ¨æ”¹è®Šæ™‚æ‰ç¹ªè£½ï¼Œä¿ç•™æ­¤è¡Œ
    
    // ã€æ–°å¢ã€‘åˆå§‹åŒ–é‡åŠ›
    gravity = createVector(0, 0.2);
    colorMode(HSB); // ä½¿ç”¨ HSB é¡è‰²æ¨¡å¼ï¼Œè®“ç…™ç«é¡è‰²è®ŠåŒ–æ›´æ–¹ä¾¿
} 

// score_display.js ä¸­çš„ draw() å‡½æ•¸ç‰‡æ®µ

function draw() { 
    // æ¸…é™¤èƒŒæ™¯ï¼Œä½¿ç”¨å¸¶æœ‰é€æ˜åº¦çš„é»‘è‰²èƒŒæ™¯å¯ä»¥ç”¢ç”Ÿå°¾è·¡æ•ˆæœ
    background(0, 0, 0, 50); // èƒŒæ™¯ä½¿ç”¨é»‘è‰²å¸¶é»é€æ˜åº¦ (trail effect)
    
    let percentage = (finalScore / maxScore) * 100;

    // -----------------------------------------------------------------
    // C. è™•ç†ç…™ç«æ•ˆæœ (å„ªå…ˆé¡¯ç¤ºåœ¨èƒŒæ™¯ä¹‹ä¸Š)
    // -----------------------------------------------------------------
    for (let i = fireworks.length - 1; i >= 0; i--) {
        fireworks[i].update();
        fireworks[i].show();
        if (fireworks[i].done()) {
            fireworks.splice(i, 1); // ç§»é™¤å·²çµæŸçš„ç…™ç«
        }
    }
    
    // å¦‚æœæ²’æœ‰ä»»ä½•ç…™ç«åœ¨ç•«é¢ä¸Šï¼Œä¸”æ²’æœ‰æ”¶åˆ°æ–°åˆ†æ•¸ï¼Œå¯ä»¥åœæ­¢å¾ªç’°ä»¥ç¯€çœè³‡æº
    if (fireworks.length === 0) {
        // åƒ…åœ¨æ²’æœ‰ç…™ç«å‹•ç•«æ™‚æ‰åœæ­¢å¾ªç’°ï¼Œå¦å‰‡ä¿æŒå‹•ç•«æ’­æ”¾
        // noLoop(); 
    }
    
    // -----------------------------------------------------------------
    // A. æ ¹æ“šåˆ†æ•¸å€é–“æ”¹è®Šæ–‡æœ¬é¡è‰²å’Œå…§å®¹ (ç•«é¢åæ˜ ä¸€)
    // -----------------------------------------------------------------
    
    // å°‡æ–‡æœ¬éƒ¨åˆ†è¦†è“‹åœ¨å‹•ç•«ä¹‹ä¸Šï¼Œå› æ­¤ä½¿ç”¨ç™½è‰²èƒŒæ™¯æ¸…é™¤å±€éƒ¨å€åŸŸä»¥ç¢ºä¿æ–‡æœ¬æ¸…æ™°
    fill(255, 200); // åŠé€æ˜ç™½è‰²èƒŒæ™¯ï¼Œçªå‡ºæ–‡å­—
    rectMode(CENTER);
    rect(width / 2, height / 2, width, 250); // è¦†è“‹æ–‡å­—å‘¨åœå€åŸŸ
    
    textSize(80); 
    textAlign(CENTER);
    
    if (percentage >= 100 && maxScore > 0) {
        // ã€ä¿®æ”¹ã€‘æ»¿åˆ†ä¸”éé›¶åˆ†ï¼šé¡¯ç¤ºç¥è³€æ–‡æœ¬
        fill(255, 255, 0); // é»ƒè‰²
        text("ğŸ‰ å®Œç¾ï¼æ­å–œæ»¿åˆ†ï¼ ğŸ‰", width / 2, height / 2 - 50);
        
    } else if (percentage >= 90) {
        // æ»¿åˆ†æˆ–é«˜åˆ†ï¼šé¡¯ç¤ºé¼“å‹µæ–‡æœ¬ï¼Œä½¿ç”¨é®®è±”é¡è‰²
        fill(0, 200, 50); // ç¶ è‰² 
        text("æ­å–œï¼å„ªç•°æˆç¸¾ï¼", width / 2, height / 2 - 50);
        
    } else if (percentage >= 60) {
        // ä¸­ç­‰åˆ†æ•¸ï¼šé¡¯ç¤ºä¸€èˆ¬æ–‡æœ¬ï¼Œä½¿ç”¨é»ƒè‰²
        fill(255, 181, 35); 
        text("æˆç¸¾è‰¯å¥½ï¼Œè«‹å†æ¥å†å²ã€‚", width / 2, height / 2 - 50);
        
    } else if (percentage = 0) {
        // ä½åˆ†ï¼šé¡¯ç¤ºè­¦ç¤ºæ–‡æœ¬ï¼Œä½¿ç”¨ç´…è‰²
        fill(200, 0, 0); 
        text("éœ€è¦åŠ å¼·åŠªåŠ›ï¼", width / 2, height / 2 - 50);
        
    } else {
        // å°šæœªæ”¶åˆ°åˆ†æ•¸æˆ–åˆ†æ•¸ç‚º 0
        fill(150);
        text(scoreText, width / 2, height / 2);
    }

    // é¡¯ç¤ºå…·é«”åˆ†æ•¸
    textSize(50);
    fill(50);
    text(`å¾—åˆ†: ${finalScore}/${maxScore}`, width / 2, height / 2 + 50);
    
    
    // -----------------------------------------------------------------
    // B. æ ¹æ“šåˆ†æ•¸è§¸ç™¼ä¸åŒçš„å¹¾ä½•åœ–å½¢åæ˜  (ç•«é¢åæ˜ äºŒ)
    // -----------------------------------------------------------------
    
    if (percentage >= 90) {
        // ç•«ä¸€å€‹å¤§åœ“åœˆä»£è¡¨å®Œç¾ 
        fill(0, 200, 50, 150); // å¸¶é€æ˜åº¦
        noStroke();
        circle(width / 2, height / 2 + 150, 150);
        
    } else if (percentage >= 60) {
        // ç•«ä¸€å€‹æ–¹å½¢ 
        fill(255, 181, 35, 150);
        rectMode(CENTER);
        rect(width / 2, height / 2 + 150, 150, 150);
    }
}

// =================================================================
// æ­¥é©Ÿä¸‰ï¼šå®šç¾©ç…™ç«å’Œç²’å­é¡åˆ¥ (ç”¨æ–¼ç‰¹æ•ˆ)
// -----------------------------------------------------------------

class Particle {
    constructor(x, y, hu, firework) {
        this.pos = createVector(x, y);
        this.firework = firework;
        this.lifespan = 255;
        this.hu = hu; // ç²’å­çš„è‰²ç›¸ (Hue)

        if (this.firework) {
            // ç…™ç«ä¸Šå‡éšæ®µ (ç«ç®­)
            this.vel = createVector(0, random(-12, -8));
        } else {
            // çˆ†ç‚¸å¾Œçš„ç²’å­
            this.vel = p5.Vector.random2D(); // éš¨æ©Ÿæ–¹å‘
            this.vel.mult(random(2, 10)); // éš¨æ©Ÿé€Ÿåº¦
        }
        this.acc = createVector(0, 0);
    }

    applyForce(force) {
        this.acc.add(force);
    }

    update() {
        if (!this.firework) {
            this.vel.mult(0.9); // çˆ†ç‚¸ç²’å­é€Ÿåº¦éš¨æ™‚é–“è¡°æ¸›
            this.lifespan -= 4; // å£½å‘½æ¸›å°‘ï¼Œç”¢ç”Ÿæ¶ˆå¤±æ•ˆæœ
        }
        this.vel.add(this.acc);
        this.pos.add(this.vel);
        this.acc.mult(0); // é‡è¨­åŠ é€Ÿåº¦
    }

    done() {
        return this.lifespan < 0;
    }

    show() {
        if (!this.firework) {
            // çˆ†ç‚¸ç²’å­
            strokeWeight(2);
            stroke(this.hu, 255, 255, this.lifespan);
        } else {
            // ç«ç®­ (ä¸Šå‡ç²’å­)
            strokeWeight(4);
            stroke(this.hu, 255, 255);
        }
        point(this.pos.x, this.pos.y);
    }
}

class Firework {
    constructor(x, y) {
        this.hu = random(255); // éš¨æ©Ÿé¡è‰²
        this.firework = new Particle(x, y, this.hu, true); // ç«ç®­ç²’å­
        this.exploded = false;
        this.particles = [];
    }

    update() {
        if (!this.exploded) {
            this.firework.applyForce(gravity);
            this.firework.update();

            // çˆ†ç‚¸æ¢ä»¶ï¼šç•¶ç«ç®­é–‹å§‹ä¸‹å¢œæ™‚
            if (this.firework.vel.y >= 0) {
                this.exploded = true;
                this.explode();
            }
        }

        for (let i = this.particles.length - 1; i >= 0; i--) {
            this.particles[i].applyForce(gravity);
            this.particles[i].update();
            if (this.particles[i].done()) {
                this.particles.splice(i, 1);
            }
        }
    }

    explode() {
        for (let i = 0; i < 100; i++) { // ç”Ÿæˆ 100 å€‹ç²’å­
            const p = new Particle(this.firework.pos.x, this.firework.pos.y, this.hu, false);
            this.particles.push(p);
        }
    }

    show() {
        if (!this.exploded) {
            this.firework.show();
        }
        
        for (const p of this.particles) {
            p.show();
        }
    }

    done() {
        return this.exploded && this.particles.length === 0;
    }
}
